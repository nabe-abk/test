
<$local(x, y)>

<$local(qtitle) = esc(Query.title) || '取引先'>
<$v.title = "「<@qtitle>」選択">

<$local(query) = make_query_amp()>
<$local(url)   = v.thisurl . '?' . query>

<!--=========================================================================-->

<$ifset(!Query.sort,  Query.sort, '-lastuse_ymd')>
<$Query.limit ||= 100>

<$local(list, hits) = v.load_clients(Query)>

<!--=========================================================================-->
<article>
<h2><@v.title></h2>
<div class="body">
	<div class="search">
	<form method="GET">
		<div class="iblocks">
		<span class="iblock"><$x = Query.ctype>
		<select name="ctype" class="js-on-change-submit ctype-<@esc(x)>">
			<option class=""           value=""<@		if(x eq '',	' selected')>>種別</option>
			<option class="ctype-購入" value="buy"<@	if(x eq 'buy',	' selected')>>購入</option>
			<option class="ctype-販売" value="sale"<@	if(x eq 'sale',	' selected')>>販売</option>
		</select></span>

		<span class="iblock">
		<select name="sort" class="js-on-change-submit"><$x = Query.sort>
			<option value="kana"<@		if(x eq 'kana',		' selected')>>カナ▲</option>
			<option value="-kana"<@		if(x eq '-kana',	' selected')>>カナ▼</option>
			<option value="name"<@		if(x eq 'name',		' selected')>>名称▲</option>
			<option value="-name"<@		if(x eq '-name',	' selected')>>名称▼</option>
			<option value="zipcode"<@	if(x eq 'zipcode',	' selected')>>郵便番号▲</option>
			<option value="-zipcode"<@	if(x eq '-zipcode',	' selected')>>郵便番号▼</option>
			<option value="use_cnt"<@	if(x eq 'use_cnt',	' selected')>>使用回数▲</option>
			<option value="-use_cnt"<@	if(x eq '-use_cnt',	' selected')>>使用回数▼</option>
			<option value="lastuse_ymd"<@	if(x eq 'lastuse_ymd',	' selected')>>最終使用日▲</option>
			<option value="-lastuse_ymd"<@	if(x eq '-lastuse_ymd',	' selected')>>最終使用日▼</option>
		</select></span>

		<span class="iblock">
			<input class="num w80" type="number" name="limit" min="100" max="10000" step="100" value="<@int(Query.limit) || 100>">件
		</span>

		<span class="iblock">
			<input id="q" class="w300" type="text" name="q" value="<@esc(Query._q)>"><button>検索</button>
			<@ifexec(Query._q ne '')>
			<button id="clear">クリア</button>
			<script type="module">
				$('#clear').click(function(){ $('#q').val('') })
			</script>
			<$end>
		</span>

		<@ifexec(Query._new, begin)>
		<span class="iblock">
			<button type="button" data-href="<@myself2><@v.skel_dir>select_new?<@query>">新規登録</button>
		</span>
		<$end>
		</div>
	</form>
	</div>

	<div class="nosp">
		<span class="iblock">
			<label><input class="js-switch js-save" name="cs_address" data-fast="1" data-target=".address,.zipcode" type="checkbox" checked>住所</label>
		</span>
		<span class="iblock">
			<label><input class="js-switch js-save" name="cs_tel" data-fast="1" data-target=".tel" type="checkbox" checked>TEL</label>
		</span>
		<span class="iblock">
			<label><input class="js-switch js-save" name="cs_fax" data-fast="1" data-target=".fax" type="checkbox">FAX</label>
		</span>
		<span class="iblock">
			<label><input class="js-switch js-save" name="cs_tags" data-fast="1" data-target=".tags" type="checkbox" checked>タグ</label>
		</span>
		<span class="iblock">
			<label><input class="js-switch js-save" name="cs_use_info" data-fast="1" data-target=".use_info" type="checkbox" checked>最終使用</label>
		</span>
	</div>

<@ifexec(list && @list, begin, begin)>
	<$x = ##list+1>
	<@ifexec(x == hits, begin, begin)>
		<p>全 <@hits> 件表示</p>
	<$else>
		<p><@x>件 / <@hits>件中（<a href="<@url>&amp;limit=all">全件表示</a>）</p>
	<$end>

	<div class="table-container">
	<table class="list slim"><thead>
	<tr>
		<th class=""><a href="<@url>&amp;sort=name">名称</a></th>
		<th class="">購</th>
		<th class="">売</th>

		<th class="nosp zipcode"><a href="<@url>&amp;sort=zipcode">郵便番号</a></th>
		<th class="address">住所</th>
		<th class="nosp tel">Tel</th>
		<th class="nosp fax">FAX</th>
		<th class="">タグ</th>

		<th class="nosp use_info small"><a href="<@url>&amp;sort=<@if(x eq 'use_cnt', '-')>use_cnt">使用数</a></th>
		<th class="nosp use_info"><a href="<@url>&amp;sort=<@if(x eq 'lastuse_ymd', '-')>lastuse_ymd">最終使用</a></th>
		<th>選択</th>
	</tr>
	</thead>
	<tbody>
	<@foreach(local(t), list)>
	<tr<@foreach_keys(local(x), t)> data-<@x>="<@replace(t.(x), '"', '&quot;')>"<$end>>	<@> " → &quot; は不要だが念の為
		<td class="" title="<@t.kana>"><a href="<@myself2>client/view?pkey=<@t.pkey>"><@t.name></a></td>
		<td class="c"><@if(t.for_buy,  '✓')></td>
		<td class="c"><@if(t.for_sale, '✓')></td>

		<td class="nosp nowrap zipcode"><@t.zipcode></td>
		<td class="address"><@t.pref><@t.address1></td>
		<td class="nosp nowrap tel"><@t.tel></td>
		<td class="nosp nowrap fax"><@t.fax></td>
		<td class="nowrap tags"><@v.parse_tags(t.tags)></td>

		<td class="nosp num  use_info"><@t.use_cnt></td>
		<td class="nosp date use_info"><@t.lastuse_ymd></td>
		<td class="nowrap c">
			<button class="select-client" type="button">選択</button>
		</td>
	</tr>
	<$end>
	</tbody>
	</table>
	</div><!-- table-container -->

<$else>
	<p class="error">見つかりません。</p>
<$end>

</div></article>

<script type="module">
	$('button.select-client').on('click', function(){
		const $obj = $(this).closest('tr');
		if (window.opener) window.opener.selected_client($obj.data());
		window.close();
	})
</script>
