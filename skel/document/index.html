<$local(x, dis)>

<$v.title ||= "書類一覧">
<$local(query) = '?' . make_query_amp()>
<$local(url)   = v.thisurl . query>

<script type="module">
	asys.set_cookie('document_backurl', '<@url>');
</script>

<!--=========================================================================-->

<@call("_sub/menu_tree")>

<$ifset(!Query.sort, Query.sort, '-ymd')>
<$local(list, hits) = v.load_documents(Query)>

<$local(c_pkey) = int(Query.c_pkey)>
<$local(c_name) = c_pkey && v.load_client_name(c_pkey)>
<$ifset(c_pkey, v.title, "『<@c_name>』の" . v.title)>

<!--=========================================================================-->
<article>
<h2><@v.title></h2>
<div class="body">
	<div class="search">
	<form method="GET">
		<@ifexec(c_pkey)>
		<input type="hidden" name="c_pkey" value="<@c_pkey>">
		<$end>

		<div class="iblocks">

		<span class="iblock"><$dis = if(Query.from_date || Query.to_date, ' disabled')>
		<select name="year" class="js-on-change-submit"<@dis>><$x = Query.year>
			<option value="">年</option>
		<@foreach(local(t), reverse(from_to(v.start_year || 2025, Now.year)))>
			<option value="<@t>"<@if(x == t, ' selected')>><@t>年</option>
		<$end>
		</select><select name="mon" class="js-on-change-submit"<@dis || if(!Query.year, ' disabled')>><$x = Query.mon>
			<option value="">月</option>
		<@foreach_num(local(t), 12)>
			<option value="<@t>"<@if(x == t, ' selected')>><@t>月</option>
		<$end>
		</select></span>

		<span class="iblock"><$dis = if(Query.year || Query.mon, ' disabled')>
			<input class="js-on-change-submit" type="date" max="9999-12-31" name="from_date" value="<@esc(Query.from_date)>"<@dis>> ～ <@\>
			<input class="js-on-change-submit" type="date" max="9999-12-31" name="to_date" value="<@esc(Query.to_date)>"<@dis>>
		</span>

		<span class="iblock">
			<$local(min) = Query.min_price>
			<$local(max) = Query.max_price>
			<$x = Query.price_type>
			<select name="price_type" class="<@if(min ne '' || max ne '', 'js-on-change-submit')>">
				<option value="total"<@   if(x eq 'total',    ' selected')>>総額</option>
				<option value="subtotal"<@if(x eq 'subtotal', ' selected')>>税抜</option>
				<option value="tax"<@     if(x eq 'tax',      ' selected')>>税額</option>
				<option value="remain"<@  if(x eq 'remain',   ' selected')>>残高</option>
			</select>
			<input type="text" class="price w80 js-on-change-submit" name="min_price" value="<@if(min ne '', v.printc(min))>"> ～ <@\>
			<input type="text" class="price w80 js-on-change-submit" name="max_price" value="<@if(max ne '', v.printc(max))>">
		</span>
		<span class="iblock">
			<label><input type="checkbox" class="js-on-change-submit" name="remain" value="1"<@if(Query.remain, ' checked')>>残高あり</label>
		</span>
		</div>

		<div class="iblocks">
		<span class="iblock"><$x = Query.dtype>
		<select name="dtype" class="js-on-change-submit">
			<option value="">種別</option>
		<@foreach_keys(local(t), v.dtypes)>
			<option class="dtype-<@t>" value="<@t>"<@if(t eq x, ' selected')>><@t></option>
		<$end>
		</select></span>

		<span class="iblock"><$x = Query.dformat>
		<select name="dformat" class="js-on-change-submit">
			<option value="">書式</option>
		<@foreach_keys(local(t), v.dformats)>
			<option class="dformat-<@t>" value="<@t>"<@if(t eq x, ' selected')>><@t></option>
		<$end>
		</select></span>

		<span class="iblock">
		<select name="sort" class="js-on-change-submit"><$x = Query.sort>
			<option value="ymd"<@		if(x eq 'ymd',		' selected')>>日付▲</option>
			<option value="-ymd"<@		if(x eq '-ymd',		' selected')>>日付▼</option>
			<option value="kana"<@		if(x eq 'kana',		' selected')>>カナ▲</option>
			<option value="-kana"<@		if(x eq '-kana',	' selected')>>カナ▼</option>
			<option value="name"<@		if(x eq 'name',		' selected')>>名称▲</option>
			<option value="-name"<@		if(x eq '-name',	' selected')>>名称▼</option>
			<option value="subtotal"<@	if(x eq 'subtotal',	' selected')>>税抜▲</option>
			<option value="-subtotal"<@	if(x eq '-subtotal',	' selected')>>税抜▼</option>
			<option value="tax"<@		if(x eq 'tax',		' selected')>>税額▲</option>
			<option value="-tax"<@		if(x eq '-tax',		' selected')>>税額▼</option>
			<option value="total"<@		if(x eq 'total',	' selected')>>総額▲</option>
			<option value="-total"<@	if(x eq '-total',	' selected')>>総額▼</option>
			<option value="paid_ymd"<@	if(x eq 'paid_ymd',	' selected')>>決済日▲</option>
			<option value="-paid_ymd"<@	if(x eq '-paid_ymd',	' selected')>>決済日▼</option>
			<option value="remain"<@	if(x eq 'remain',	' selected')>>残高▲</option>
			<option value="-remain"<@	if(x eq '-remain',	' selected')>>残高▼</option>
			<option value="create_tm"<@	if(x eq 'create_tm',	' selected')>>登録日▲</option>
			<option value="-create_tm"<@	if(x eq '-create_tm',	' selected')>>登録日▼</option>
			<option value="update_tm"<@	if(x eq 'update_tm',	' selected')>>更新日▲</option>
			<option value="-update_tm"<@	if(x eq '-update_tm',	' selected')>>更新日▼</option>
		</select></span>

		<span class="iblock">
			<input class="num w80" type="number" name="limit" min="100" max="10000" step="100" value="<@int(Query.limit) || 100>">件
		</span>

		<span class="iblock">
			<input id="q" class="w300" type="text" name="q" value="<@esc(Query._q)>"><button>検索</button>
			<@ifexec(ENV.QUERY_STRING)>
			<button type="button" data-href="<@v.thisurl>">クリア</button>
			<$end>
		</span>
		</div>
	</form>
	</div>

	<div class="nosp">
		<span class="iblock">
			<label><input class="js-switch js-save" name="dcode" data-fast="1" data-target=".dcode" type="checkbox">書類コード</label>
		</span>
		<span class="iblock">
			<label><input class="js-switch js-save" name="d_pay" data-fast="1" data-target="table .pay" type="checkbox" checked>決済情報</label>
		</span>
		<span class="iblock">
			<label><input class="js-switch js-save" name="d_create_tm" data-fast="1" data-target=".create_tm" type="checkbox" checked>登録日</label>
		</span>
		<span class="iblock">
			<label><input class="js-switch js-save" name="d_update_tm" data-fast="1" data-target=".update_tm" type="checkbox" checked>更新日</label>
		</span>
	</div>

<@ifexec(list && @list)>
	<$x = ##list+1>
	<@ifexec(x == hits)>
		<p>全 <@hits> 件表示</p>
	<$else>
		<p><@x>件 / <@hits>件中（<a href="<@url>&amp;limit=all">全件表示</a>）</p>
	<$end>

	<$local(sum)  = {}>
	<$local(cols) = arrayq(subtotal tax total paid remain)>
	<div class="table-container">
	<table class="list slim js-sortable-value"><thead><$x=Query.sort>
	<tr>
		<th class=""><a href="<@url>&amp;sort=<@if(x eq 'ymd', '-')>ymd">日付</th>
		<th class=""><a href="<@url>&amp;sort=<@if(x eq 'kana', '-')>kana">相手</a></th>
		<th class="">種別</th>
		<th class="">書式</th>
		<th class="nosp dcode">コード</th>
		<th class="title">概要</th>
		<th class="nosp price"><a href="<@url>&amp;sort=<@if(x eq 'subtotal', '-')>subtotal">税抜</a></th>
		<th class="nosp tax-rate">税率</th>
		<th class="nosp price"><a href="<@url>&amp;sort=<@if(x eq 'tax', '-')>tax">税額</a></th>
		<th class="price"><a href="<@url>&amp;sort=<@if(x eq 'total', '-')>total">総額</a></th>

		<th class="nosp pay date"><a href="<@url>&amp;sort=<@if(x eq 'paid_ymd', '-')>paid_ymd">決済日</th>
		<th class="nosp pay price"><a href="<@url>&amp;sort=<@if(x eq 'remain', '-')>remain">残高</th>

		<th class="nosp create_tm"><a href="<@url>&amp;sort=<@if(x eq 'create_tm', '-')>create_tm">登録日</a></th>
		<th class="nosp update_tm"><a href="<@url>&amp;sort=<@if(x eq 'update_tm', '-')>update_tm">更新日</a></th>
		<th>操作</th>
	</tr>
	</thead>
	<tbody>
	<@foreach(local(t), list)>
	<tr>
		<td class="date"><a href="<@myself2><@v.skel_dir>view?pkey=<@t.pkey>"><@t.ymd></a></td>
		<td class="" title="<@t.kana>"><a href="<@myself2>client/view?pkey=<@t.c_pkey>"><@t.name></a></td>
		<td class="c nowrap spFirstLetter dtype dtype-<@t.dtype>"><@t.dtype></td>
		<td class="c nowrap spFirstLetter dformat dformat-<@t.dformat>"><@t.dformat></td>
		<td class="nosp dcode"><@t.dcode></td>
		<td class="title"><@t.title></td>

		<td class="nosp price" data-sort="<@t.subtotal>"><@v.printc(t.subtotal)></td>
		<td class="nosp tax-rate" data-sort="<@t.tax_rate>"><@t.tax_rate>%</td>
		<td class="nosp price" data-sort="<@t.tax>"><@v.printc(t.tax)></td>
		<td class="price" data-sort="<@t.total>"><@v.printc(t.total)></td>

	<@ifexec(t.dformat eq v.dformat_invoice)>
		<td class="nosp pay date"><@t.paid_ymd></td>
		<td class="nosp pay price" data-sort="<@t.remain>"><@v.printc(t.remain)></td>
	<$else>
		<td class="nosp pay c">-</td>
		<td class="nosp pay c" data-sort="0">-</td>
	<$end>

		<td class="nosp date create_tm" title="<@t.create_tm>"><@v.parse_datetm(t.create_tm)></td>
		<td class="nosp date update_tm" title="<@t.update_tm>"><@v.parse_datetm(t.update_tm)></td>
		<td class="nowrap c">
			<a href="<@myself2><@v.skel_dir>edit?pkey=<@t.pkey>&amp;direct=1">編集</a>
		</td>
		<$foreach(local(x), cols)><$sum.(x) += t.(x)><$end>
	</tr>
	<$end>
	</tbody>
	<tfoot>
	<tr class="nosp">
		<td colspan="1" class="dcode noborder"></td>
		<td colspan="5" class="r noborder">表示合計</td>

		<td class="num"><@v.printc(sum.subtotal)></td>
		<td class="num"></td>
		<td class="num"><@v.printc(sum.tax)></td>
		<td class="num"><@v.printc(sum.total)></td>

		<td class="pay"></td>
		<td class="pay num" id="view-total-remain"><@v.printc(sum.remain)></td>

		<td class="create_tm noborder"></td>
		<td class="update_tm noborder"></td>
		<td class="noborder"></td>
	</tr>
	<tr class="sp">
		<td colspan="4" class="r">表示合計</td>
		<td colspan="2" class="num"><@v.printc(sum.total)></td>
		<td class=""></td>
	</tr>
	</tfoot>
	</table>
	</div><!-- table-container -->

<$else>
	<p class="error">見つかりません。</p>
<$end>

</div></article>
